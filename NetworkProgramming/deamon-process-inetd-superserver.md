# 守护进程和 inetd 超级服务器

守护进程(daemon process)是在后台运行的进程，与控制终端无关。Unix 系统通常有许多守护进程(大约 20 到 50 个)，它们在后台运行，执行不同的管理任务。

缺少控制终端通常有一个副作用，是要由系统初始化脚本启动的(例如，在启动时)。但是守护进程如果得通过用户指定输入运行脚本开启，那么就要把守护进程从控制终端分离出来避免不要的交互，通过作业控制、终端会话管理、或是简单的在守护进程在后台运行的时候避免不必要的输出到终端。

这里有一些启动守护进程的方法：

1. **通过运行脚本**。在系统启动期间，许多守护进程是通过系统初始化脚本启动的。这些脚本通常位于 /etc 目录或名称以 /etc/rc 开头的目录中，但它们的位置和内容依赖于实现。由这些脚本启动的守护进程以超级用户权限开始。

   一些网络服务器也经常从这些脚本启动：inetd 超级服务器(后面将讨论)、Web 服务器和邮件服务器(通常是 sendmail)。我们将在后续中描述的 syslogd 守护进程也是由这些脚本之一启动的。

2. **通过 inetd 超级服务启动**。许多网络服务器是由 inetd 超级服务启动的。inetd 本身是从步骤 1 中的一个脚本启动的。inetd 会监听这些网络请求（Telnet、FTP 等），并且当一个请求到达时会调用那些实际的服务（Telnet Server、FTP Server 等）。

3. **通过 cron 守护进程启动**。cron 守护进程会定期执行，它调用的程序作为守护进程运行。在系统启动过程中，在步骤 1 中启动 cron守护进程本身。

4. **通过 corn 守护进程在未来某个时间点启动**。由 at 命令指定的。cron 守护进程通常在这些程序到达时间时启动它们，因此这些程序作为守护进程运行。

5. **通过用户终端、前台、后台启动（一般用作测试）**。守护进程可以从用户终端启动，既可以在前台也可以在后台。这通常在测试守护进程或重新启动因某些原因终止的守护进程时进行

## syslogd 守护进程

在 Unix 系统中，syslog 进程一般是通过初始化脚本伴随系统启动而启动的。它主要执行下面几步：

1. 读取配置文件（一般在 /etc/syslog.conf）指定了守护进程如何处理可以接收的每种类型的日志消息。这些信息是追加文件的形式（一个特殊的情况是文件 /dev/console，它将消息写入控制台）写入到特定用户(如果该用户已登录)，或转发到另一台主机上的 syslogd 守护进程。
2. 创建一个 Unix 域 Socket 并绑定到路径名 /var/run/log(在某些系统上是 /dev/log)。
3. 创建 UDP Socket 并绑定端口 514（即 syslog 服务）。
4. 路径 /dev/klog 是开放的。任何来自 kernel 内部的错误信息都作为该设备的输入显示。

syslogd 守护进程在一个无限循环中运行，该循环调用 select，等待它的三个描述符(步骤 2、3、4)中的任何一个可读；它读取日志消息，并执行配置文件对该消息执行的操作。如果守护进程接收到SIGHUP 信号，它将重新读取其配置文件。

通过创建 Unix 域数据报套接字并将消息发送到守护进程绑定的路径名，我们可以将日志消息从守护进程发送到 syslogd 守护进程，但更简单的接口是 syslog 函数，我们将在下一节中描述它。或者，我们可以创建一个 UDP 套接字并将我们的日志消息发送到环回地址和端口 514。