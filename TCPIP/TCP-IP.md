## TCP

TCP 协议是面向传输的协议，是属于传输层。

客户端之间的 TCP 连接首先从建立连接（Connection）开始，成功建立连接之后，两个端在应用层上就属于两个会话（Session）。

### TCP的握手与挥手

首先先说明下 TCP 几个核心操作：

- SYN；请求同步，即客户端A与客户端B建立连接，A会发起一个连接请求到B，这个过程称为 SYN；
- PSH；发送数据，一个端向另一个端发送数据包；
- FIN；一个端主动断开请求，称为 FIN，此时请求完成；
- ACK；反馈确认，对上面的三个操作，所达端都要发送一个ACK回去响应。

### 三次握手

端到端的 TCP 连接是通过三次握手建立的，以客户端A与客户端B建立TCP连接为例：

1. 一次握手

   - 客户端A向B发出建立连接请求，即SYN；

2. 二次握手

   - 客户端B针对SYN返回一个ACK作为响应，表示准备好建立连接；

   - **同时发送一个SYN给客户端A**

3. 第一次握手后，双方已经做好建立连接的准备了。三次握手

   - 客户端A针对B的SYN作出响应，即向B发送一次ACK。

4. 至此A，B成功建立连接

### 四次挥手

断开连接由一方主动发起断开连接请求

1. 一次挥手
   - 客户端A向B发出断开连接请求，即FIN；
2. 二次挥手
   - 客户端B针对A的SYN请求返回ACK响应，表示准备断开连接
   - 此时B不能向A马上发送FIN请求，因为网络有延迟，客户端B可能还有没有ACK的包以及一些清理操作要处理，即不能像建立连接一样合并
3. 三次挥手
   - 客户端B向A发出断开连接请求，即FIN
4. 四次挥手
   - 客户端A针对B的SYN请求返回ACK响应，表示准备断开连接，并进行一些清理操作。

### 为什么TCP连接需要三次握手和四次挥手？

首先要知道的是 TCP 是面向连接（connection-oriented）的协议；并且 TCP 连接提供的是全双工服务（full-duplex service）：如果客户端A与另一个端B存在一条TCP连接，那么应用层数据就可以在A进程流向B进程的同时，也可以从进程B流向进程A。TCP连接 也是点对点（point-to-point）的，即存在单个发送方与单个接收方之间的连接。

所以当一个进程向另一个进程发送数据之前，这两个进程必须要建立连接，“互相握手”。

### TCP的保活机制

有这么两种情况：

1. 客户端和服务器需要直到什么时候要断开连接。
2. 双方之间不需要传输任何数据，只需要一个空的连接即可。

一种不影响双方数据传输，探测对方的方式。由一个保活计时器实现的。计时器被激活，连接一端需要发送一个保活探测报文，另一端接收报文的同时会发送一个ACK响应。

坏处：

1. 出现短暂的网络波动，会引起原本健康的连接断开。
2. 会占用不必要的贷款，特别现在是流量计费的时代。
3. 成本也会相应更高。

## 拥塞控制

如何准确判断何时需要减缓且减缓TCP传输？又是如何恢复的？

流量控制机制是通过 TCP 的拥塞控制窗口大小字段控制的，在网络传输中会将这个字段信息传递出去。

慢启动算法：短时间有大量的数量传输。

FACK（转发确认）= overdamping（过度衰减） + rampdowm(缓慢衰减)。还有一种叫`带参数界定的速率减半(Rate-Halving with Bounding Parameters)`：在一个 RTT 内，重复收到两个 ACK，TCP 即可发送一个新的数据包。

### 专业术语

RTO(Retransmission Timeout)：重传超时。

ssthresh(slow start threshold)：慢启动阈值。

cwnd(Congestion windows)：拥塞窗口。

Eifel 算法包括两个部分：

- Eifel 响应算法：处理重传超时计时器和重传计时器超时后的拥塞控制
- Eifel 检测算法：通过一定的算法来检测 RTO 的真实性

CWR(Congestion Window Reduce): 拥塞窗口缩减，发送方每接收两个 ACK，就将 cwnd 减 1，直到 cwnd 等于新的 ssthresh 值或是由于其它原因结束的 cwr（如丢包）。





