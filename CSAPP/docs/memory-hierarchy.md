# 存储层次结构

存储器系统是一个具有不同容量、成本和访问时间的存储设备的层次结构。CPU 寄存器保存最常用的数据，CPU 高速缓存紧靠 CPU，容量很小，速度很快。主存容量比较大，速度也快但是没有高速缓存块。磁盘容量最大，也是最便宜的，但是速度不快。

## 随机访问存储器（RAM）

主要分为两类：（静态存储器）SRAM 和 DRAM

SRAM：主要作为 CPU 的高速缓存存储器，速度要比 DRAM 块。SRAM 将每个位存储在一个双稳态的存储器单元里。一个存储单元使用一个 6 晶体管电路来实现的。这个电路可以无限期保持在两个不同的电压配置或状态之一。并且不受电波干扰，当干扰因素消除时，就会自动回复稳定值。

DRAM：主要为主存使用。SRAM 将每个位存储为对一个电容的充电。这个电容非常小，容易收到干扰，一旦被干扰就永远不会恢复。看着好像 DRAM 没什么用处，实则不然。一是计算机运行的时钟周期是以纳秒来衡量的，而 DRAM 单元一般会在 10~100 毫秒时间内失去电荷（收到干扰），所以这么一比较就会发现这段时间而言保持的相对比较长了。二是内存系统本身是通过**周期性的读出，然后重写来刷新内存的每一位**。

优劣势对比：

SRAM：每位晶体管数有 6 个，所以耗电也高，成本高，速度块，对外干扰因素不敏感

DRAM：每位晶体管数有 1 个，成本相对低，速度相对 SRAM 慢，对外干扰因素敏感

> RAM 全称：Random-Access Memory；

DRAM 在读取数据是通过内部的一个内存控制器来控制的，通过行请求脉冲（Row-Access Strobe）将地址发送给 DRAM，然后就是列请求脉冲（Column Access Strobe）。反过来也是类似的，将内容作为响应发送给内存控制器。

非易失性存储器：相比 SRAM，RAM 这两种易失性（断电会丢失信息）的随机存储内存，还有一个非易失性粗出其，其中一个现代最重要的就是闪存（flash memory），它是基于**电子可擦除 PROM**（Electrically Erasable PROM，EEPROM）拓展的。还有一种被称为**可擦写可编程 ROM**（Erasable Programmable ROM,EPROM）

## 如何访问主存

**数据流是通过总线的共享电子电路在处理器和 DRAM 主存之间来回交互的**。每次 CPU 和主存之间的数据传送都是通过一系列步骤来完成的，这些步骤被称为**事务总线（bus transaction）**。读事务从主存传输数据到 CPU。写事务从 CPU 传输数据到主存。

总线是由一组并行的导线，能携带地址信息、数据和控制信号。控制线携带的信号会同步事务，会标识当前正在处理的事务操作的类别。

![image-20200921172154022](asserts\20200921172154022)	

内存总线：连接 I/O桥接器和主存

I/O桥接器：将系统总线的电子信号翻译成内存总线的电子信号。

拿一个指令具体来描述 CPU 发生了什么

```c
movq  A, %rax
```

1. 地址 A 的内容被加到寄存器 %rax 中。
2. CPU 上的总线接口的电路在系统总线上发起读事务
   1. CPU 将地址 A 放到系统总线上
   2. I/O 桥将信号传递给内存总线
   3. 主存感觉到了在内存总线上的地址信号，从内存总线上读地址，从 DRAM 取出数据并写入到内存总线
3. I/O 桥将内存总线信号翻译成系统总线信号，并沿系统总线传递
4. CPU 感觉到系统总线上的地址数据，从总线上读数据，并将数据复制到寄存器 %rax 中。

```c
movq  %rax, A
```

1. CPU 将地址 A 放到内存总线。主存读出这个地址，并等待数据字
2. CPU 将数据放入总线上
3. 主存从总线读数据字，并存储到地址 A

## 磁盘