# 网络编程

每个网络应用都是基于**客户端-服务器模型**的。这个模型可以由一个服务器和一个或多个客户端进程组成。服务器管理资源，通过某种操作将资源提供给客户端。比如 Web 服务器管理本机磁盘文件，它可以供给客户端检索和执行。

一个客户端与服务器交互主要由四个步骤组成：

1. 客户端需要某种资源，向服务器发起一个请求
2. 服务器接受请求并解析，操作其中的资源
3. 服务器将资源响应给客户端，并等待下次客户端的请求
4. 客户端接受到服务器响应的资源，并继续处理

## TCP/IP

TCP/IP 是传输控制协议/互联网络协议。是协议族，分别都提供不同的功能。

IP 提供命名机制和递送机制，它是不可靠的，因为数据包可以丢失和重复而不会恢复。

UDP 是拓展 IP，是在 IP 之上的一个协议，提供一个可靠的双工（双向）通信通道。**通信无需三次握手**

TCP/IP 解决了什么问题？

因为因特网之间的主机有不同的主机字节顺序，彼此是不兼容的。但是 TCP/IP 的出现，它提供了一种标准协议，统一了命名格式和数据包格式，定义了数据项的字节顺序。

IP 地址是以 16 进制表示的，如 `0x8002c2f2` 就等于 IP 地址的点十进制的 `128.2.194.242`。

由于 IP 地址太多太复杂，不好记住，所以又提出来“域名”的概念来助记 IP 地址。

## Socket

在 TCP/IP 之下的就是 Socket，一个 Socket 是连接的一个端点，对应一个地址：`因特网地址:端口`（端口为 16 位整数）。这个 Socket 地址是由内核自动分配的。

Socket 创建连接的过程：

1. 客户端与服务端通过 `socket` 函数创建一个**“socket 描述符”**，此时还不能用于读写，因为返回的 socket 描述符没有全部打开，只打开了一部分。
2. 客户端使用 `connect` 函数与服务器建立连接并返回 `socket 描述符` 给客户端（此操作为同步操作），成功建立连接之后此时客户端可以与服务端进行通信了，**并准备好读写了**
3. 通过 `bind` 绑定服务器 socket 地址和 socket 描述符
4. 服务器在建立连接响应请求期间，会创建一个“**监听描述符**”来接受请求
5. 最后服务器接收请求（通过 `accept` 函数）并将发起请求的客户端的地址记录下来并返回一个“**已连接描述符**”。

**这里要注意，监听描述符与已连接描述符是有区别的，监听描述符在客户端与服务端建立连接起就一直存在与 socket 的整个生命周期，而已连接描述符存在每次的请求当中，表示的是客户端与服务哦端建立连接。**

## 网络请求的过程

当客户端发起一个 GET 请求如：user?name=marsonshine&age=27，具体在计算机中发生了什么？

当服务器接收到这样一个请求之后，首先会 fork 一个子进程，执行 cgi（通用网关接口） 脚本，解析连接并接收参数。在服务器处理之后响应内容返回给客户端，这个过程同样是通过子进程完成的，将标准输出重定向到和客户端相关联的已连接描述符直达客户端。

**简而言之就是客户端和服务端通过因特网使用 socket 建立连接。一个 socket 是连接的一个端点，连接是以文件描述符的形式提供给应用程序的。socket 接口提供了打开和关闭 socket 描述符的函数。客户端和服务器通过读写这些描述符来实现彼此间的通信。**

