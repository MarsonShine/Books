# 分布式一致性和共识

什么是共识（consensus）：就多个节点就某件事达成一致。

如**主节点选举**：所有节点就谁来充当主节点是要达成一致的，避免出现脑裂，多主现象，从而会导致数据行为的不一致性。

**原子事务提交**：跨事务（分区）某个事物可能在 A 节点执行成功，但是可能在其他节点执行失败。那么所有节点的事务结果必须达成一致。**即要么全部成功，要么全部失败。**

原子事务提交的解决方案：2PC，两阶段提交。

2PC 是一种共识算法，用来多节点之间控制要么全部提交，要么全部失败（中止）的一种解决方案。

2PC 实际上是**引入了一个中间件（协调者，也叫事务管理器），它实际上是一种共享库，能共同访问所有节点**。整个事务执行过程共分为两个阶段：1. 准备阶段；2. 提交阶段。

**准备阶段**：协调者会生成一个唯一的字增长事务 ID，并给每个阶段发出请求询问是否准备好提交事务，并等待节点的回应。如果有任意一个节点回复 “否”，则整个过程放弃执行（中止），否则进入**提交阶段**执行事务提交。

这里有一个潜在的缺陷，因为 2PC 是靠着能与所有节点通信的协调者来执行整个事务过程的，那么如果当成功进入准备阶段之后在提交阶段之前，协调者发生故障，那么这些节点都只能等待协调者恢复连接并等待事务提交。整个过程所有节点就会因此无限阻塞下去。

所以 3PC 就作为 2PC 的替代方案出现了。它是以一个边界条件为前提的：它假设在有限的网络延迟和节点规定的延时时间内相应。换句话就是在 2PC 的基础上加了**故障检测器**，它会检测超时时间或节点/协调者是否出现故障。在超过设定的边界值之后 3PC 会默认执行事务提交操作。所以 3PC 是非阻塞式提交。

> 3PC 3阶段的来源其实就是将 2PC 的准备阶段进一步分成了两个阶段：准备阶段（CanCommit），预提交阶段（PreCommit）提交阶段（Commit）。3PC 在预提交阶段会发送请求，**询问是否准备好执行，于是各个节点会在本地执行事务，并将成功与否的结果返回协调者。**只有全部回复 “是”，则会进入事务提交阶段。

## 共识算法的基本性质

- 协商一致性（uniform agreement）：所有节点都接受相同的决策
- 诚实性（integrity）：所有节点都不能反悔。即对一次提议不能有多次决定。
- 合法性（Validity）：如果决定了 v 值，那么这个 v 值一定是其中一个节点提议的。
- 可终止性（Termination）：节点如果不崩溃，则最终一定可以达成决议。

简而言之就是**决定一致的结果，一旦决定，就无法改变。**

> 全序关系广播实际上与共识是密切相关的。
>
> 全序关系广播：消息要按照相同的顺序发送到所有节点，有且只有一次。

