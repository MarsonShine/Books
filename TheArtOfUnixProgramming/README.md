# Unix 编程艺术

## Unix 优化篇

### 对称多处理

**对称多处理（Symmetric Multiprocessing，SMP）**是一种计算机架构，其中计算机系统包含多个处理器（也称为核心），这些处理器**共享同一主内存和系统总线**。在 SMP 系统中，所有处理器都可以同时访问系统内存和 I/O 设备，并且它们之间没有主从关系。这意味着每个处理器都可以执行相同的指令集，并且没有一个处理器比其他处理器更重要。SMP 系统在许多现代计算机中得到广泛应用，它们允许并行处理多个任务，提高计算性能和系统吞吐量。

优点：
1. 并行处理：SMP 系统可以同时执行多个任务，从而提高整体计算性能和响应时间。
2. 灵活性：所有处理器都可以执行相同的任务，无需对软件进行特殊优化，使得编程和应用开发更加简单。
3. 可伸缩性：SMP 系统可以通过添加更多的处理器来扩展性能，提供更大的计算能力。

然而，SMP 也有一些局限性，主要是由于处理器共享同一主内存和总线，可能导致内存访问瓶颈和性能瓶颈。

为了克服这些问题，有时会使用非均匀存储访问（Non-Uniform Memory Access，NUMA）架构。

> 对称多处理其实一种复用处理器提高程序执行并行性的一种优化方式。在 SMP 结构中，计算机系统可以分为四类：单指令单数据流（SISD）、单指令多数据流（SIMD）、多指令单数据流（MISD）、多指令多数据流（MIMD）。
>
> 1. SISD：只有一个处理器核心，执行单个指令流，并且处理的数据是单个数据流。这种模型下的计算机系统是串行执行的，即每个时钟周期只执行一个指令。它适用于顺序算法和串行任务。
> 2. SIMD：**有多个处理器核心，所有核心都执行相同的指令，但是每个核心处理的是不同的数据**。即一个指令同时作用于多个数据元素。这种模型适用于执行同样操作的数据并行任务，例如向量和矩阵运算。常见的图形处理器（GPU）就是采用 SIMD 模型来加速图形渲染和通用计算。
> 3. MIMD：**有多个处理器核心，每个核心可以执行不同的指令流，且处理的数据可以是不同的**。这意味着每个核心都可以**独立地执行不同的任务**，无需与其他核心同步。MIMD 模型适用于并行处理不同的任务或数据，每个任务可能有不同的算法和执行要求。典型的多核 CPU 和分布式计算系统就采用了 MIMD 模型。
> 4. MISD（Multiple Instruction, Single Data）：有多个处理器核心，每个核心执行不同的指令流，但是处理的数据是相同的。这种模型相对较少使用，因为对于同一数据进行不同的操作并不常见。实际应用中，更常见的是 MIMD 模型，多个核心可以独立处理相同的数据，每个核心执行不同的指令。

### 非均匀存储访问

非均匀存储访问是一种计算机架构，其中多个处理器组成节点，每个节点都有自己的本地内存。节点之间通过高速互联（例如快速的互连网络）连接，以实现内存共享和数据传输。在NUMA系统中，访问本地内存的速度比访问远程节点的内存速度快得多。

优点：

1. 内存访问局部性：由于每个处理器有自己的本地内存，处理器可以更快地访问自己节点的内存，从而减少了内存访问延迟。
2. 可扩展性：NUMA系统可以通过添加更多节点来扩展计算能力，而不会像SMP系统那样受到内存访问瓶颈的限制。

然而，NUMA系统也存在一些挑战，主要是因为需要在节点之间进行数据传输。如果任务在一个节点的内存中访问频繁，并且需要访问另一个节点的内存，就会导致性能下降。因此，在编程和应用开发时，需要考虑数据的局部性和内存访问模式，以优化NUMA系统的性能。

### 数据一致性

虽然非均匀存储访问引入了本地缓存再一定程度上解决了工具共享问题，但是本质上本地内存的值还是通过多级缓存共享而来。比如当多核芯同时对同一个内存地址读写时，由于写操作并不会立即将修改后的值传播到其它所有核心的本地缓存，就会导致其它核心读取数据时得到的还是旧数据。这个时候就会出现数据一致性问题。

而解决这个问题需要引入一个 [MESI（Modified,Exclusive,Shared,Invalid）协议]([Books/CSAPP/docs/cache-in-deep.md at master · MarsonShine/Books (github.com)](https://github.com/MarsonShine/Books/blob/master/CSAPP/docs/cache-in-deep.md#mesi协议))来解决。该协议通过在缓存之间进行消息传递和状态更新，确保核心之间对相同内存地址的访问时有序的，从而保持内存的一致性。