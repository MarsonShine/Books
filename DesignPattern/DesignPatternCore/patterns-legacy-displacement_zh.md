# 遗留系统迁移模式

遗留软件系统的有效现代化

*当面临更换现有软件系统的需要时，组织通常会陷入半完成技术更换的循环。我们的经验告诉我们一系列模式，使我们能够打破这个循环，依靠：有意识地认识到取代遗留软件的预期结果，打破这种部分的取代，逐步交付这些部分，并改变组织的文化，认识到变化是不变的现实。*

## 传统替换跑步机

我们与许多组织合作，他们多次尝试删除遗留系统。在一个相当典型的组织中，他们经历了一系列长达 3-5 年的现代化方案。每次他们都会定义一种新的技术方法，然后作为大型多年现代化计划的一部分，朝着这种新方法努力。

在每个项目的某个阶段，他们都会遇到一个危机点，即不断变化的业务需求会超越当前的技术策略，从而引发重新开始的需求。在采用瀑布式"大爆炸"方法的项目中，这意味着放弃大部分工作。在其他采用渐进式交付方法的情况下，所采取的方法只是在已经非常复杂的基础上增加一层稍新的技术。在这两种情况下，他们都无法停止使用之前的传统堆栈，节省成本和降低风险的关键业务目标仍然无法实现，这是许多传统替换工作的常见结果。

在他们的反复失败中有几个关键因素在起作用。

首先，他们看到的糟糕结果在很大程度上是组织的产物；具体来说，它是领导力、结构和工作方式。他们认为，只要选择更新的技术，即使是其他一切或多或少保持不变，他们就会得到与过去不同的结果。但事后看来，这显然是不现实的。

其次，现代化将通过一个大型变革方案来实现，该方案本身由一系列项目和小组组成的。这些项目被视为与任何 BAU（Business As-Usual，业务不变）是互相独立的。因此，BAU 继续针对现有系统交付业务需求，而新的项目团队则根据替换计划开始时商定的一组需求进行交付。

随着时间的推移，他们发现企业的实际需求与计划开始时实际签署的需求之间的差距越来越大。每个项目运行的时间越长，项目计划与 BAU 和未来需求之间的差距就越大。虽然已经制定了变更控制流程来为计划增加新的需求，但这些流程非常耗时，而且由于前期供应商合同的原因，成本高得令人望而却步。

失败的第三个关键因素是希望与现有系统和业务流程实现功能均等。这些尝试开始时承诺给企业提供与现在完全相同的系统和流程，但在背后以某种方式对技术进行了"改进"。在经历了多次失败并担心中断的情况下，企业领导者认为这是一种风险较低的策略。这里的挑战在于，即使是定义和商定当前的"原样"功能也是一项巨大的工作，它导致了一个大型的单一"大爆炸"切换发布计划。

我们从这个组织和许多其他组织中观察到的是，技术最多只是遗留问题的50%，工作方式，组织结构和领导力对成功同样重要。

## 打破循环

显然，有必要打破“技术替代方案”的循环。简而言之，组织需要能够继续满足业务需求，同时取代过时的技术，所有这些都是在加速技术变革和更严峻的竞争环境的背景下进行的。

我们发现了一系列方法可以帮助应对这些挑战。它们有助于应对将问题分解为更小部分的挑战，以便在改进技术的同时满足新要求。从广义上讲，它们分为四类：

1. 了解您想要实现的结果
2. 决定如何将问题分解为更小的部分
3. 成功交付零件
4. 更改组织以允许这种情况持续发生

### 了解您想要实现的结果

对于一个组织来说，在处理遗留问题时，就他们想要实现的结果达成一致是至关重要的。虽然这似乎是显而易见的，但组织的不同部门往往对预期结果有完全不同的看法。大多数遗留现代化计划都涉及我们在下面列出的几个结果，但在开始旅程之前确定哪些是优先事项至关重要。

#### 降低变更成本

许多组织在决定处理遗留问题时的一个关键转折点是，由于机会成本（也称为延迟）或实施成本，所需的业务更改开始的成本远远超过任何预期收益。一个预警信号是，不得不花费数周时间、数万或数十万美元对网站进行改动，却只能带来微小的业务绩效增长。

在这一点上，进行任何不能带来巨大投资回报的变革往往不再可能是合理的。换句话说，技术状况已经开始决定企业可以进行的变革规模。对于许多企业来说，这意味着是进行 "BAU" 变革还是必须启动一个更大的项目。这些大型项目会吸引所有以前不合理的小变革，从而增加其范围、成本和风险。

#### 改进业务流程

我们已经看到很多这样的例子：业务流程是在传统系统的基础上发展起来的，流程与系统的工作方式紧密相连，系统中的制约因素和 "系统外 "的变通方法往往影响着人们的工作流程。

我们看到的一个例子是，一家航空公司的值机系统使用"绿屏"终端，由于传统系统的限制，流程必须按照严格的顺序进行，这意味着修正或错误意味着重新开始值机流程。此外，该航空公司最初不提供转机服务，当增加转机服务时，由于技术限制，必须在原有系统中作为一个单独的工作流程来完成。因此，如果在办理值机手续时，乘客没有提到他们有一个转机航班，那么就会有错误的流程，包括打印错误的行李标签，只有在这之后，系统才会标记转机航班。通过改变流程，值机工作人员的工作和乘客的体验本可以得到很大改善，但由于传统系统的原因，这是不可能的。

因此，**更新和改变业务流程反过来也需要改变支持技术的工作方式**，这一点不足为奇。试图在不改变技术的情况下改变工作流程往往会导致"非系统"工作，即人们将数据提取到电子表格或类似表格中，在那里进行处理，然后再将数据导入到原有系统中。

在一家企业中，整个库存订购流程实际上是在团队经理个人电脑上运行的 Microsoft Access 数据库中完成的。由于传统系统无法支持供应商的新工作方式，他们感到非常沮丧。他们每周都会进行几次数据的导入和导出，与此同时，由于没有人意识到发生了什么，企业的其他部门会看到过时的数据。

值得注意的是，这种变通方法的根本原因往往是要求更换系统以支持数据的导入和导出。

#### 淘汰旧系统

旧系统需要被淘汰得一个常见原因是传统系统现代化。这通常是由于在支持旧硬件或软件方面面临挑战，例如支持成本上升以及硬件和软件的支持合同到期等问题。

我们发现，从业务的角度来看待旧系统的退役是非常有用的。**因此，基于旧技术构建的系统本身并不足以成为更换的理由。相反，我们需要考虑这对业务造成的影响，如运行成本上升或因缺乏支持或系统知识而产生的风险。**

虽然有些组织对旧技术的淘汰进行了很好的规划，但许多组织似乎忽视了这一问题，直到它达到危机点。反过来，这往往会促使企业采用看似低干扰选项或速赢的现代化方法，这些通常是反模式，我们将在后面介绍其中的一些陷阱。

多年来，我们对许多大型企业在不支持的硬件和软件上运行其业务感到震惊，在 eBay 上购买备件是我们经常听到的故事。如果您使用的是传统技术，值得进行一次适当的调查，并创建一个日历，记录各种生命周期支持的终止日期。

虽然许多组织将旧系统的退役作为遗留系统现代化的关键成果，但实际情况并非如此，遗留系统仍在使用，相关业务目标仍未实现。

#### 即时中断

对于一些企业来说，解决遗留问题的临界点可能是由于外部因素造成的，如监管变化、新"启动"的竞争对手或现有竞争对手的重大变化。当面临"非做不可"的变革时，往往会发现应对所需的资金和时间已经变得过于庞大。

外部事件使组织的领导层清楚地认识到，他们不再有能力以相应的成本进行变革。

#### 更新的技术

**采用新技术不应该成为传统现代化的原因，只是为了自身而拥有更新的技术很少是任何组织的关键目标**。相反，应该以最能**满足当前和未来业务需求**的方式选择和选择它。这里的一个挑战是技术变革的步伐正在加快，技术的“有用”寿命越来越短。“有用”的实际定义取决于组织，但通常我们需要考虑以下事项：

- 允许竞争优势
- 匹配竞争对手或市场产品
- 允许更快的变化步伐
- 更换成本更低
- 运行成本较低

我们今天对最佳和最有用技术的选择很可能会在相对较短的时间内被更好的替代技术所取代。这就使得在寻找满足未来需求的技术方面做出正确决策的潜在风险非常大。

一个好的方法是不要做出任何在 2-3 年内不能轻易"重来"的选择。这对技术选择以及整体设计和方法都有影响。当我们认识到变化的速度在不断加快时，选择一个 5-10 年才能收回成本的大型平台是很难成立的。

### 决定如何将问题分解为更小的部分

从广义上讲，这包括在当前业务和技术架构中找到正确的"接缝"。重要的是，您必须考虑当前解决方案的元素如何映射到不同的业务能力。对于传统系统，这通常意味着发现一个大型技术解决方案是如何满足多种业务需求的，然后看看是否有可能通过一个新的解决方案来提取独立交付的个别需求。理想情况下，这些需求应可交付，且相互之间的依赖性最小。

一个常见的反对意见是，找到这些缝隙（seams）太困难了。虽然我们同意这在一开始是具有挑战性的，但我们发现这是比其他方法更好的方法，因为其他方法往往会导致功能均等和大爆炸式的发布。我们还注意到，许多企业之所以排除这种方法，是因为他们孤立地看待技术或业务流程。单独改变技术的一部分或更新业务流程很可能会失败，但如果我们能够将两者结合起来考虑和实施，就有办法"吃掉大象"。

#### 开始吧

在旅程的开始阶段，遗产现代化似乎是一个最令人生畏的命题。与任何旅程一样，我们必须首先尝试并了解最初的方向。此外，与所有旅程一样，您必须从您所在的地方开始。我们经常遇到的一个问题是，我们似乎从一片森林中开始，看不到前方的风景，因此也不知道要走的方向。因此，第一步就是爬到树上，仔细观察四周！这意味着要在最短的时间内尽可能了解当前的系统和架构。这通常很难做到，而且很容易被过多的细节所困扰。

幸运的是，有许多非常有用的工具可以协同使用，以获得足够好的理解，从而继续工作。这些工具将在其他地方进行详细讨论，但总结列表将包括[事件风暴（Event Storming）](http://ziobrando.blogspot.com/2013/11/introducing-event-storming.html)、[Wardley 映射（Wardley Mapping）](https://blog.gardeviance.org/2015/02/an-introduction-to-wardley-value-chain.html)、业务能力映射（Business Capacity Mapping）和领域映射（Domain Mapping）。请注意，在这份清单中，我们主要关注的是业务概念如何映射到系统架构中，进而了解该[架构如何支持价值生成](https://martinfowler.com/articles/value-architectural-attribute.html)。这是一个经常被忽略的视角，尤其是对于传统系统而言。

了解问题的模式：

| [创建城镇计划](https://martinfowler.com/articles/patterns-legacy-displacement/create-town-plan.html) † | 确定组织的稳定部分，围绕这些部分组建团队和软件 |
| ------------------------------------------------------------ | ---------------------------------------------- |
| [事件风暴](https://martinfowler.com/articles/patterns-legacy-displacement/event-storming.html) † | 用于了解业务流程的技术                         |
| [识别业务能力](https://martinfowler.com/articles/patterns-legacy-displacement/identify-business-capabilities.html) † | 确定组织的稳定部分，围绕这些部分组建团队和软件 |
| [价值流图](https://martinfowler.com/articles/patterns-legacy-displacement/value-stream-map.html) † | 描述用户如何完成工作的工件                     |

具体来说，我们发现人们常常在遗留系统的边界上停止发现式的活动，"龙在这里"，不再前进。如果不跨越边界，揭示遗留系统是如何支持（或阻碍）业务流程和活动的，就很难找到并提取薄片进行交付。

另一个经常被忽视但非常有价值的信息来源是系统用户本身。事实上，根据作者的经验，这往往是您能够找到大量有用信息的地方，尤其是能够揭露许多变通方法和影子 IT 生态系统，这些通常是围绕旧系统建立起来的，即实际运行业务的 Access 数据库和版本化 Excel 电子表格。客户旅程映射（Customer Journey Mapping）、创建服务蓝图（Service Blueprints）和价值流映射（Value Stream Mapping）等工具在揭示此类细节方面效果显著。

解决问题的模式：

| [提取产品线](https://martinfowler.com/articles/patterns-legacy-displacement/extract-product-lines.html) | 按产品线识别和分离系统                         |
| ------------------------------------------------------------ | ---------------------------------------------- |
| [提取价值流](https://martinfowler.com/articles/patterns-legacy-displacement/extract-value-streams.html) | 识别并分离关键价值流                           |
| [功能平价](https://martinfowler.com/articles/patterns-legacy-displacement/feature-parity.html) | 使用新技术堆栈复制旧系统的现有功能。           |
| [唯一真环](https://martinfowler.com/articles/patterns-legacy-displacement/one-true-ring.html) | 通过识别独特和共享的业务能力，对问题进行细分。 |

### 成功交付部件

对快速变更的需求，以及在没有大量依赖关系的情况下逐步交付和独立变更业务元素的能力，往往导致"敏捷"交付方法与基于微服务的架构并存。持续交付成为这些可单独部署组件的必备条件。除了普通的软件交付之外，更具挑战性的是找到从现有大型解决方案中分离出来、与之共存并最终取代其元素的策略。有几种成功的策略，包括**并行运行**、**入口分叉**和**分流**。

交付模式：

| [金丝雀发布](https://martinfowler.com/articles/patterns-legacy-displacement/canary-release.html) | 向部分用户推出变更                                           |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [关键聚合器](https://martinfowler.com/articles/patterns-legacy-displacement/critical-aggregator.html) | 整合来自不同业务部门的数据，为关键决策提供支持               |
| [暗启动](https://martinfowler.com/articles/patterns-legacy-displacement/dark-launching.html) | 在不使用结果的情况下调用新的后端功能，以评估其性能影响分流   |
| [分流](https://martinfowler.com/articles/patterns-legacy-displacement/divert-the-flow.html) | 首先将跨组织活动从传统业务中转移出来                         |
| [事件拦截](https://martinfowler.com/articles/patterns-legacy-displacement/event-interception.html) | 拦截对系统状态的任何更新，并将其中一些更新路由到新组件。     |
| [模仿传统系统](https://martinfowler.com/articles/patterns-legacy-displacement/legacy-mimic.html) | 新系统与旧系统交互时，旧系统不会察觉到任何变化。             |
| [还原到源](https://martinfowler.com/articles/patterns-legacy-displacement/revert-to-source.html) | 确定数据的源头，并集成到源头。                               |
| [停止世界切换](https://martinfowler.com/articles/patterns-legacy-displacement/stop-the-world.html) | 在切换到新系统时暂停正常业务活动                             |
| [过渡架构](https://martinfowler.com/articles/patterns-legacy-displacement/transitional-architecture.html) | 为简化遗留系统的迁移而安装的软件元素，我们打算在迁移完成后将其移除。 |

### 更改组织以允许这种情况持续发生

如果我们后退一步，审视一下交付新业务需求的整个过程，我们很快就会发现这只是技术问题的一部分。如果我们使用较新的技术来减少构建解决方案的时间和成本，那么我们就会发现任何与达成需求和将变更投入生产有关的问题。

我们需要改变组织结构和流程，以充分利用更好的技术，而且根据[康威定律](https://github.com/MarsonShine/MS.Microservice/blob/master/docs/ConwayLaw.md)，我们还需要一个有利于实现这一点的技术架构。如果团队和他们的沟通是围绕现有的解决方案和流程来组织的，我们可能需要使用[反康威法（Inverse Conway Maneuver）](https://martinfowler.com/bliki/ConwaysLaw.html#icm)来重组他们，以匹配新的解决方案和架构。

传统系统会制约和限制采用更现代化工程实践的能力，尤其是那些与极限编程和持续交付相关的实践。在替换传统系统时，重要的是要确保改变工作方式，以确保我们最终不会回到一个缓慢、难以改变且成本高昂的系统。

传统也是组织文化和领导力的产物，如果没有更广泛的变革，你应该期待与以前相同的结果。我们观察到，许多传统的现代化努力都因"企业抗体"而失败，"企业抗体"会发现新事物，并采取行动将其拒之于组织之外。

我们曾与一家大型电信公司合作，该公司希望为移动电话开发软件。该公司的领导层都明白，这意味着反馈周期更快，变革更频繁，而他们看到的是，与现有的专注于固定基础设施的项目相比，这意味着更快的反馈周期和更频繁的变革。

尽管领导层都明白这一点，但他们并没有改变现有的工作实践，也没有改变负责这些流程的中层管理人员。因此，现有的变更控制流程被严格执行。最终，软件团队花费在填写变更控制表格和参加变更控制会议上的时间比他们生产软件的时间还多。“企业抗体”成功地拒绝了新的工作方式。

组织变革是一个很大的话题，已经有很多文献可供参考。很少有组织能够在重新设计（或重建，对于外包受害者）其整个交付方法以及其组织结构和关键业务流程的同时，推迟遗留问题的现代化。尽管组织变革这一更广泛的话题超出了我们的范围，但我们还是推荐了一些在传统背景下应用和保护新工作方式的策略。如果你只是改变传统的工作方式，而不做任何其他事情，那么几年后，你将会再次取代传统的工作方式。

持续的组织变革模式：

| [按照您的需求进行构建](https://martinfowler.com/articles/patterns-legacy-displacement/build-as-you-mean-to-continue.html) | 以您需要的方式创建您的传统替代品，以便在其上线后继续运营。   |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [新公司](https://martinfowler.com/articles/patterns-legacy-displacement/new-co.html) | 成立一家全新的公司，以打破市场格局。                         |
| [受保护的试点](https://martinfowler.com/articles/patterns-legacy-displacement/protected-pilot.html) | 为新工作创建一个试点项目，并将其从正常的公司治理流程中分离出来。 |

在组织转型方面肯定还有其他战略和方法，我们只是强调了这两种，因为在某种程度上，这两种战略和方法可以让我们尽早开始传统的现代化工作。

## 例子：集成中间件移除