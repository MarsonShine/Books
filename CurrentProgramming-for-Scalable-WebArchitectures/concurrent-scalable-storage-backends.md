# 并发和可扩展存储后端

在前几章中,我们建议尽可能避免使用状态。我们提出的 Web 服务器内部架构基于无共享的体系结构。在编程应用逻辑时,我们倾向于将共享可变状态的使用降至最低。然而,只有少数 Web 应用程序可以完全忽略任何形式的状态。无状态设计适用于验证或计算服务,以及其他一些应用程序。但实际上,几乎所有其他 Web 应用程序都需要某种持久状态作为整体应用程序的重要组成部分。在我们的架构模型中,我们将状态处理工作外包给了专用的后端服务。

在本章中,我们将考虑并发性和可扩展性对存储后端的影响。我们将阐述在**分布式数据库系统中保证一致性的挑战**,并介绍不同的一致性模型。然后我们将概述分布式数据库系统的一些内部概念,并描述它们如何处理复制和分区。最后,我们将介绍不同类型的分布式数据库系统并评估它们的特性。

分布式数据库系统的挑战
-----------------------------

在考虑大规模 Web 应用时,我们需要可扩展且支持并发的存储后端。所谓可扩展性,我们所追求的是可提高数据容量和读/写吞吐量。在我们的模型中,应用服务器需要并行处理大量请求。由于它们依赖后端存储系统,我们同样需要应对这一级别的高并发访问。

只有采用横向扩展机制,才能持续提高吞吐量和容量。即使使用专用硬件设备,单个数据库服务器的扩展也只能达到一定的负载水平。因此,我们需要一个并发分布式系统来实现可扩展的后端存储。

后端存储必须持久保存应用程序状态,因此在读写数据时,我们也期望数据保持一定程度的一致性。我们所面对的是一个分布式系统,必须预先考虑故障情况。即使单个节点发生故障,整个存储系统仍应无缝运行并保持可用性。同样,我们执行的存储操作是作为 Web 请求的一部分,因此要求操作的低延迟。

这些一般要求导致我们遇到分布式系统的一个重要障碍,即布鲁尔(Brewer)定理关于一致性、可用性和分区容错性之间的关联。

### CAP 定理

布鲁尔于 2000 年提出了 CAP 猜想[^Bre00],后被 Gilbert 和 Lynch[^Gil02]证实为定理。布鲁尔认为,分布计算相对容易,分布式系统的难点实际上在于持久化状态。此外,他提出了分布式系统的三个不同特性,它们之间存在内在关联。

**一致性**

一致性特性描述了分布式系统所有节点对数据的一致视图。也就是说,系统保证操作具有原子特性,并且对所有节点同时传播变更,从而产生相同的结果。

**可用性** 

该特性要求系统最终对每个请求作出响应,即使在发生故障的情况下也是如此。这对读写操作都是如此。在实践中,这一特性通常被简化为在合理的时间内作出有界响应。但是, Gilbert 和 Lynch 证实了这一定理甚至适用于无界的最终响应。

**分区容错性**

该特性描述了系统能够容忍节点间的消息丢失。分区是系统节点之间的任意分裂,导致中间完全失去消息。这影响了前面的两个特性。维护一致性的机制必须应对消息丢失。根据可用性特性,任何潜在分区的每个节点都必须能够响应请求。

布鲁尔定理的核心陈述如下:

> "对于任何共享数据系统,您最多只能获得这三个特性中的两个。"

我们已经看到,所有特性都是理想的。但任何实际系统都必须在这些特性之间进行权衡,至少放弃其中一个,如图 6.1 所示。因此我们有三种不同的组合,特征显著不同。

![](./asserts/cap.svg)

图 6.1：根据 Brewer 定理[^Bre00]，一个分布式系统可以同时保证的不同属性。







[^Bre00]: 
[^Gil02]: 