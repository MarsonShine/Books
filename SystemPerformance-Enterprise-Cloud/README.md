## 性能分析的 **USE** 方法

简而言之，**USE（utilization、saturation、errors）**就是对所有的资源，查询它的使用率、饱和度和错误。

- **资源**：所有服务器物理元器件（CPU、总线...）。依赖的软件也都包括算内，提供有用的指标。
- **使用率**：在规定的时间范围内，资源用于服务工作的时间百分比。
- **饱和度**：资源不能再服务更多额外的工作的程度，通常指等待队列。
- **错误**：错误事件的个数。

## 5 Why

在分析问题的时候，要用到**”5 Why“**的技巧：问自己”为什么“，然后作答，以此重复5遍。以下是一个例子：

1. 查询多了数据库性能就开始变差。为什么？
2. 由于内存换页磁盘I/O延时。为什么？
3. 数据库内存用量变得太大了。为什么？
4. 分配器消耗的内存比应该用的多。为什么？
5. 分配器存在内存碎片问题。为什么？

## 排队系统的性能分析

Little's 定律可以体现：
$$
L = λW
$$
L = 系统请求的平均数目。

λ = 平均到达速率。

W = 平均服务时间。

一个排队系统的模型如下：

![](./asserts/1.png)

## 微基准测试

对于未来的系统，可以用微基准测试或者负载生成工具在测试环境里仿真要施加的请求，同时测量资源的使用情况。给予充足的客户负载，你能够通过实验的方式找到极限。要监视的资源如下：

- **硬件**：CPU 使用率、内存使用、磁盘IOPS、磁盘吞吐量、磁盘容量（使用率）、网络吞吐量。
- **软件**：虚拟内存使用情况、进程/任务/线程、文件描述符。

比如，你现在正在看的系统当前每秒执行 1000 个请求。最繁忙的资源是 16 个CPU，平均使用率是40%，你预测当CPU处于100%使用情况时会成为工作负载的瓶颈。问题就变成了：在那时每秒的请求率是多少？

> 每个请求的 CPU% = 总的 CPU% / 请求总数 = 16 x 40% / 1000 = 每个请求消耗 0.64% CPU。
>
> 每秒请求最大值 = 100% x 16 CPU / 每个请求消耗的 CPU% = 1600 / 0.64 = 每秒 2500 个请求。

## 统计数据

### 平均值

在性能分析的时候，我们在采集数据时会经常用到平均值作为性能参考点。平均值也分多种计算方式，它们都适合不同的测量场景：

- 几何平均值，是数值乘积的 n 次方根（n 是数值的个数）。

- 调和平均值，是数值的个数除以所有数值的倒数之和。

  例如，计算传输800 MB 数据的平均速率，当第一个100 MB 以50 MB/s 传输，剩下的700MB按10 MB/s 的门限传输时，答案是采用调和平均值，800/(100/50 + 700/10) = 11.1MB/s。

- 随着时间变化的平均值，在性能度量中，很多我们研究的指标都是随着时间变化的平均值。

- 衰退均值，衰退均值偶尔会在系统性能中使用。

### 标准方差、百分位数、中位数

**标准方差**和**百分位数**（例如，第99百分位数）是提供分布数据信息的统计技术。**标准方差度量的是数据的离散程度**，更大的数值表示着数据偏离均值（算术平均值）的程度越大。第99百分位数显示的是该点在分布上包含了99%的数值。

**中位数**就是第50百分位数，用以显示数据的大部分分布在哪。

![](./asserts/2.png)

## CPU

### 时钟频率

每个 CPU 指令都可能会花费一个或者多个**时钟周期**（称为CPU 周期）来执行。CPU 以一个特定的时钟频率执行，例如，一个 5GHz 的 CPU 每秒运行五十亿个时钟周期。

更快的时钟频率并不一定会提高性能——它取决于快速 CPU 周期里到底在做些什么。如果它们大部分时间是停滞等待内存访问，那更快的执行实际上并不能提高 CPU 指令的执行效能或者负载吞吐量。

### 指令执行

CPU 执行指令步骤：

- 取指
- 译码/解码
- 执行
- 内存访问
- 寄存器写回

上面的每一步都只至少需要一个时钟周期。内存访问时最慢的，通常需要几十个周期执行。在这个期间 CPU 会陷入停滞状态，这称为停滞周期。这也是 CPU 缓存如何重要的原因，极大的缩短了时钟周期。

> 关于指令执行过程和流水线设计可见：[处理器架构](https://github.com/MarsonShine/Books/blob/master/CSAPP/docs/processor-architecture.md)

### 指令宽度

**指令宽度**描述了同时处理的目标指令数量。现代处理器一般为宽度 3 或者宽度 4，意味着它们可以在**每个周期里最多完成 3～4 个指令**。如何取得这个结果取决于处理器本身，每个环节都有不同数量的功能单元处理指令。

### CPI/IPC

每指令周期数（CPI）：每执行一个指令需要多少个时钟周期数。这个指标同样可以用 IPC 表示；

每周期指令数（PIC）：每个周期执行了多少个指令数。

CPI 越高表示 CPU 停滞周期就越长，问题点就很有可能发生在内存访问上。CPI 越低就说明停滞周期就越短，吞吐量就越大。

### 字长

处理器是围绕最大字长设计的——32 位或者64 位——这是整数大小和寄存器宽度。**字长也普遍使用，表示地址空间大小和数据通路宽度（有时也称为位宽）**，取决于不同的处理器实现。

更宽的字长意味着更好的性能。但更宽的字长可能会在某些数据类型下因未使用的位而导致额外的内存开销（如内存对齐）。数据的大小也会因为指针大小的增加而增加，导致需要更多的内存 I/O。